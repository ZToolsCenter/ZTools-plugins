<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°çª—ç¿»è¯‘</title>
    <style>
        /* å›½æ——emojiå­—ä½“æ”¯æŒ */
        @font-face {
            font-family: 'Twemoji Country Flags';
            unicode-range: U+1F1E6-1F1FF, U+1F3F4, U+E0062-E0063, U+E0065, U+E0067, U+E006C, U+E006E, U+E0073-E0074, U+E0077, U+E007F;
            src: url('https://cdn.jsdelivr.net/gh/beyondkmp/country-flag-emoji-polyfill@master/font/TwemojiCountryFlags.woff2') format('woff2');
            font-display: swap;
        }

        :root {
            /* Light theme colors */
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #f0f1f3;
            --text-primary: #1a1a1a;
            --text-secondary: #6b7280;
            --text-tertiary: #9ca3af;
            --border-color: #e5e7eb;
            --border-color-light: #f0f1f3;
            --accent-color: #3b82f6;
            --accent-hover: #2563eb;
            --success-color: #10b981;
            --error-color: #ef4444;
            --warning-color: #f59e0b;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.07);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 14px;
            --content-bg: #ffffff;
            --frame-bg: #f8f9fa;

            /* Toasté€šçŸ¥å˜é‡ */
            --toast-bg: #ffffff;
            --toast-border: #e5e7eb;
            --toast-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --toast-success-bg: rgba(34, 197, 94, 0.1);
            --toast-success-color: #16a34a;
            --toast-success-border: rgba(34, 197, 94, 0.4);
            --toast-error-bg: rgba(239, 68, 68, 0.1);
            --toast-error-color: #dc2626;
            --toast-error-border: rgba(239, 68, 68, 0.4);
            --toast-warning-bg: rgba(251, 191, 36, 0.1);
            --toast-warning-color: #d97706;
            --toast-warning-border: rgba(251, 191, 36, 0.4);
            --toast-info-bg: rgba(59, 130, 246, 0.1);
            --toast-info-color: #2563eb;
            --toast-info-border: rgba(59, 130, 246, 0.4);
        }

        [data-theme="dark"] {
            --bg-primary: #303133;
            --bg-secondary: #282a2d;
            --bg-tertiary: #2d2d2d;
            --text-primary: #f3f4f6;
            --text-secondary: #9ca3af;
            --text-tertiary: #6b7280;
            --border-color: #3d3d3d;
            --border-color-light: #2d2d2d;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            --content-bg: #282a2d;
            --frame-bg: #303133;

            /* Toasté€šçŸ¥å˜é‡ - æš—è‰²ä¸»é¢˜ */
            --toast-bg: #303133;
            --toast-border: #4a4c4f;
            --toast-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: var(--frame-bg, var(--bg-primary));
            color: var(--text-primary);
            font-size: 14px;
            line-height: 1.5;
            overflow-y: hidden;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Top toolbar */
        .toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: var(--frame-bg, var(--bg-primary));
            gap: 8px;
            -webkit-app-region: drag;
        }

        .toolbar-logo {
            width: 20px;
            height: 20px;
            -webkit-app-region: no-drag;
        }

        .toolbar-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .toolbar-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toolbar-btn {
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
            -webkit-app-region: no-drag;
        }

        .toolbar-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .toolbar-btn svg {
            width: 16px;
            height: 16px;
        }

        .toolbar-btn.pinned {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
        }

        .toolbar-btn.pinned:hover {
            background: rgba(59, 130, 246, 0.25);
            color: #2563eb;
        }

        [data-theme="dark"] .toolbar-btn.pinned {
            background: rgba(100, 181, 246, 0.2);
            color: #64b5f6;
        }

        [data-theme="dark"] .toolbar-btn.pinned:hover {
            background: rgba(100, 181, 246, 0.3);
            color: #90caf9;
        }

        /* Source text section */
        .source-section {
            padding: 12px 16px;
            padding-bottom: 50px;
            /* Extra padding for translate button */
            background: var(--content-bg, var(--bg-secondary));
            margin: 0 10px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            position: relative;
            /* For translate button positioning */
        }

        .source-text {
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-primary);
            max-height: 80px;
            overflow-y: auto;
            word-break: break-word;
            min-height: 40px;
            width: 100%;
            border: none;
            background: transparent;
            resize: none;
            font-family: inherit;
            outline: none;
        }

        .source-text::placeholder {
            color: var(--text-tertiary);
        }

        .source-actions {
            position: absolute;
            bottom: 10px;
            left: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .source-btn {
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
            opacity: 0.7;
        }

        .source-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            opacity: 1;
        }

        .source-btn svg {
            width: 14px;
            height: 14px;
        }


        /* Controls section */
        .controls-section {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 8px;
            background: var(--content-bg, var(--bg-secondary));
            margin: 8px 10px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            gap: 8px;
            min-height: 44px;
        }

        .lang-selector {
            display: flex;
            align-items: center;
            gap: 0px;
        }

        .lang-btn {
            height: 28px;
            padding: 0 8px;
            background: #e6f3ff;
            color: #1e40af;
            border: 1px solid #60a5fa;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.15s ease;
            width: 105px;
            justify-content: center;
        }

        .lang-btn:hover {
            background: #dbeafe;
            border-color: #3b82f6;
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.2);
        }

        [data-theme="dark"] .lang-btn {
            background: rgba(59, 130, 246, 0.15);
            color: #60a5fa;
            border-color: rgba(59, 130, 246, 0.3);
        }

        [data-theme="dark"] .lang-btn:hover {
            background: rgba(59, 130, 246, 0.25);
            border-color: rgba(59, 130, 246, 0.5);
        }

        .lang-emoji {
            font-family: 'Twemoji Country Flags', 'Apple Color Emoji', 'Segoe UI Emoji', 'Noto Color Emoji', sans-serif;
            font-size: 14px;
        }

        .swap-btn {
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
            opacity: 0.7;
        }

        .swap-btn:hover {
            color: var(--text-primary);
            opacity: 1;
        }

        .swap-btn svg {
            width: 14px;
            height: 14px;
        }

        .service-icons {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-left: auto;
            flex-wrap: wrap;
        }

        .service-icon {
            width: 28px;
            height: 28px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
            padding: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .service-icon:hover {
            background: var(--bg-tertiary);
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
        }

        .service-icon.selected {
            background: rgba(59, 130, 246, 0.15);
            border-color: rgba(59, 130, 246, 0.3);
        }

        [data-theme="dark"] .service-icon.selected {
            background: rgba(100, 181, 246, 0.15);
            border-color: rgba(100, 181, 246, 0.3);
        }

        .service-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .service-icon-svg {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .service-icon-svg svg {
            width: 18px;
            height: 18px;
        }

        .result-service-icon-svg {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .result-service-icon-svg svg {
            width: 20px;
            height: 20px;
        }

        /* Results section */
        .results-section {
            flex: 0 0 auto;
            overflow-y: visible;
            padding: 0 10px 6px 10px;
            background: var(--frame-bg, var(--bg-primary));
        }

        .result-card {
            background: var(--content-bg, var(--bg-secondary));
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            margin-bottom: 10px;
            overflow: hidden;
            transition: all 0.15s ease;
        }

        .result-card:hover {
            border-color: var(--accent-color);
            box-shadow: var(--shadow-md);
        }

        .result-header {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            cursor: pointer;
            gap: 8px;
        }

        .result-service-icon {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
        }

        .result-service-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .result-service-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .result-status {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .result-action-btn {
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
        }

        .result-action-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .result-action-btn svg {
            width: 14px;
            height: 14px;
        }

        .expand-icon {
            transition: transform 0.2s ease;
        }

        .result-card.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .result-content {
            padding: 0 12px 12px;
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-primary);
            word-break: break-word;
            display: none;
        }

        .result-card.expanded .result-content {
            display: block;
        }

        /* å ä½ç¬¦æ ·å¼ - ä¸è¾“å…¥åŒºåŸŸä¿æŒä¸€è‡´ */
        .result-placeholder {
            color: var(--text-tertiary);
            font-size: 13px;
            line-height: 1.6;
        }

        .result-loading {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            color: var(--text-secondary);
        }

        .loading-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Empty state */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-tertiary);
            text-align: center;
            padding: 24px;
        }

        .empty-state svg {
            width: 48px;
            height: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        /* Language menu */
        .lang-menu {
            position: fixed;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            max-height: 280px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            min-width: 150px;
        }

        .lang-menu.show {
            display: block;
        }

        .lang-option {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.15s ease;
        }

        .lang-option:hover {
            background: var(--bg-secondary);
        }

        .lang-option.selected {
            background: rgba(59, 130, 246, 0.1);
            color: var(--accent-color);
        }

        .lang-emoji {
            font-size: 16px;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-tertiary);
        }

        /* Translate button positioned at bottom-right of input area - same style as source-btn */
        .source-translate-btn {
            position: absolute;
            bottom: 10px;
            right: 12px;
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
            opacity: 0.7;
        }

        .source-translate-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            opacity: 1;
        }

        .source-translate-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .source-translate-btn svg {
            width: 14px;
            height: 14px;
        }

        /* Toasté€šçŸ¥æ ·å¼ - ä¸ä¸»æ’ä»¶ä¿æŒä¸€è‡´ */
        .toast-container {
            position: fixed;
            top: 40px;
            right: 10px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 8px;
            pointer-events: none;
            max-width: min(300px, calc(100vw - 20px));
        }

        .toast {
            position: relative;
            background: var(--toast-bg);
            color: #374151;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            border: 1.5px solid var(--toast-border);
            box-shadow: var(--toast-shadow);
            opacity: 0;
            pointer-events: none;
            transform: translateX(100%);
            transition: all 0.3s ease;
            max-width: 100%;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.4;
        }

        /* Toastæ¯›ç»ç’ƒè’™ç‰ˆ */
        .toast::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            backdrop-filter: blur(50px);
            -webkit-backdrop-filter: blur(50px);
            z-index: -1;
        }

        [data-theme="dark"] .toast {
            color: #f3f4f6;
        }

        [data-theme="dark"] .toast::before {
            background: rgba(48, 49, 51, 0.9);
        }

        .toast.show {
            opacity: 1;
            pointer-events: auto;
            transform: translateX(0);
        }

        .toast.success {
            background: var(--toast-success-bg);
            color: var(--toast-success-color);
            border-color: var(--toast-success-border);
        }

        .toast.error {
            background: var(--toast-error-bg);
            color: var(--toast-error-color);
            border-color: var(--toast-error-border);
        }

        .toast.info {
            background: var(--toast-info-bg);
            color: var(--toast-info-color);
            border-color: var(--toast-info-border);
        }

        .toast.warning {
            background: var(--toast-warning-bg);
            color: var(--toast-warning-color);
            border-color: var(--toast-warning-border);
        }

        .toast.hide {
            opacity: 0;
            transform: translateX(100%);
        }
    </style>
</head>

<body>
    <!-- Toolbar -->
    <div class="toolbar">
        <div class="toolbar-logo">
            <img src="logo.png" alt="OCR Pro">
        </div>
        <div class="toolbar-actions">
            <button id="pin-btn" class="toolbar-btn" title="ç½®é¡¶çª—å£">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 17v5" />
                    <path
                        d="M9 10.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24V16a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V7a1 1 0 0 1 1-1 2 2 0 0 0 0-4H8a2 2 0 0 0 0 4 1 1 0 0 1 1 1z" />
                </svg>
            </button>
            <button id="settings-btn" class="toolbar-btn" title="è®¾ç½®">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path
                        d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />
                    <circle cx="12" cy="12" r="3" />
                </svg>
            </button>
            <button id="close-btn" class="toolbar-btn" title="å…³é—­">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12" />
                </svg>
            </button>
        </div>
    </div>

    <!-- Source text section -->
    <div class="source-section">
        <textarea id="source-text" class="source-text" placeholder="è¯·è¾“å…¥è¦ç¿»è¯‘çš„æ–‡æœ¬......"></textarea>
        <div class="source-actions">
            <button id="source-tts-btn" class="source-btn" title="æœ—è¯»">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="11 5,6 9,2 9,2 15,6 15,11 19,11 5" />
                    <path d="M15.54 8.46a5 5 0 0 1 0 7.07" />
                </svg>
            </button>
            <button id="source-copy-btn" class="source-btn" title="å¤åˆ¶åŸæ–‡">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect width="14" height="14" x="8" y="8" rx="2" />
                    <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" />
                </svg>
            </button>
        </div>
        <!-- Translate button in input area (bottom-right) -->
        <button id="translate-btn" class="source-translate-btn" title="ç¿»è¯‘">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="m5 8 6 6" />
                <path d="m4 14 6-6 2-3" />
                <path d="M2 5h12" />
                <path d="M7 2h1" />
                <path d="m22 22-5-10-5 10" />
                <path d="M14 18h6" />
            </svg>
        </button>
    </div>

    <!-- Controls section -->
    <div class="controls-section">
        <div class="lang-selector">
            <button id="source-lang-btn" class="lang-btn">
                <span class="lang-emoji">ï¿½</span>
                <span id="source-lang-text">è‹±è¯­</span>
                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 9l6 6 6-6" />
                </svg>
            </button>
            <button id="swap-lang-btn" class="swap-btn" title="äº¤æ¢è¯­è¨€">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M8 3L4 7l4 4" />
                    <path d="M4 7h16" />
                    <path d="M16 21l4-4-4-4" />
                    <path d="M20 17H4" />
                </svg>
            </button>
            <button id="target-lang-btn" class="lang-btn">
                <span class="lang-emoji">ğŸ‡¨ğŸ‡³</span>
                <span id="target-lang-text">ä¸­æ–‡(ç®€)</span>
                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 9l6 6 6-6" />
                </svg>
            </button>
        </div>
        <div id="service-icons" class="service-icons">
            <!-- é»˜è®¤å ä½å›¾æ ‡ï¼Œé¿å…åŠ è½½æ—¶ç©ºç™½ -->
            <div class="service-icon placeholder-icon" style="opacity: 0.3;">
                <div class="service-icon-svg">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10" />
                    </svg>
                </div>
            </div>
            <div class="service-icon placeholder-icon" style="opacity: 0.3;">
                <div class="service-icon-svg">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10" />
                    </svg>
                </div>
            </div>
            <div class="service-icon placeholder-icon" style="opacity: 0.3;">
                <div class="service-icon-svg">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10" />
                    </svg>
                </div>
            </div>
            <div class="service-icon placeholder-icon" style="opacity: 0.3;">
                <div class="service-icon-svg">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10" />
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <!-- Results section -->
    <div id="results-section" class="results-section">
        <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="m5 8 6 6" />
                <path d="m4 14 6-6 2-3" />
                <path d="M2 5h12" />
                <path d="M7 2h1" />
                <path d="m22 22-5-10-5 10" />
                <path d="M14 18h6" />
            </svg>
            <span>ç¿»è¯‘ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</span>
        </div>
    </div>

    <!-- Language menus -->
    <div id="source-lang-menu" class="lang-menu"></div>
    <div id="target-lang-menu" class="lang-menu"></div>

    <!-- Toasté€šçŸ¥å®¹å™¨ -->
    <div id="toast-container" class="toast-container"></div>

    <script>
        // Mini Translate Window Logic
        (function () {
            // State
            let sourceText = '';
            let sourceLang = { code: 'en-us', name: 'è‹±è¯­', emoji: 'ğŸ‡¬ğŸ‡§' };
            let targetLang = { code: 'zh-cn', name: 'ä¸­æ–‡(ç®€)', emoji: 'ğŸ‡¨ğŸ‡³' };
            let selectedModels = [];
            let allModels = [];  // æ‰€æœ‰ç¿»è¯‘æ¨¡å‹ï¼ˆæœ€å¤š4ä¸ªï¼‰
            let translateResults = {};
            window.translateResults = translateResults;  // Expose for parent window access
            let isTranslating = false;
            let isPinned = false;

            // å°çª—ç¿»è¯‘é…ç½®
            let miniTranslateConfig = {
                autoTranslateOnBlur: false,   // ç»“æŸç¼–è¾‘åè‡ªåŠ¨ç¿»è¯‘
                instantAutoTranslate: false,  // ç«‹åˆ»è‡ªåŠ¨ç¿»è¯‘
                instantAutoTranslateDelay: 0.5, // ç«‹åˆ»è‡ªåŠ¨ç¿»è¯‘å»¶è¿Ÿæ—¶é—´ï¼ˆç§’ï¼‰
                autoCloseOnCopy: false,  // å¤åˆ¶åè‡ªåŠ¨å…³é—­
                copyFirstModel: false,    // é»˜è®¤å¤åˆ¶æ¨¡å‹ä¸€ç»“æœ
                enableDoubleClickRightCopy: true  // åŒå‡»å³é”®å¤åˆ¶åŠŸèƒ½
            };

            // ç«‹åˆ»è‡ªåŠ¨ç¿»è¯‘é˜²æŠ–å®šæ—¶å™¨
            let instantTranslateTimer = null;

            // Language list (no auto-detect option - real-time detection updates selectors directly)
            const languages = [
                { code: 'zh-cn', name: 'ä¸­æ–‡(ç®€)', emoji: 'ğŸ‡¨ğŸ‡³' },
                { code: 'zh-tw', name: 'ä¸­æ–‡(ç¹)', emoji: 'ğŸ‡¨ğŸ‡³' },
                { code: 'en-us', name: 'è‹±è¯­', emoji: 'ğŸ‡¬ğŸ‡§' },
                { code: 'ja', name: 'æ—¥è¯­', emoji: 'ğŸ‡¯ğŸ‡µ' },
                { code: 'ko', name: 'éŸ©è¯­', emoji: 'ğŸ‡°ğŸ‡·' },
                { code: 'fr', name: 'æ³•è¯­', emoji: 'ğŸ‡«ğŸ‡·' },
                { code: 'de', name: 'å¾·è¯­', emoji: 'ğŸ‡©ğŸ‡ª' },
                { code: 'es', name: 'è¥¿ç­ç‰™è¯­', emoji: 'ğŸ‡ªğŸ‡¸' },
                { code: 'ru', name: 'ä¿„è¯­', emoji: 'ğŸ‡·ğŸ‡º' },
                { code: 'pt', name: 'è‘¡è„ç‰™è¯­', emoji: 'ğŸ‡µğŸ‡¹' },
                { code: 'it', name: 'æ„å¤§åˆ©è¯­', emoji: 'ğŸ‡®ğŸ‡¹' },
                { code: 'ar', name: 'é˜¿æ‹‰ä¼¯è¯­', emoji: 'ğŸ‡¸ğŸ‡¦' },
                { code: 'th', name: 'æ³°è¯­', emoji: 'ğŸ‡¹ğŸ‡­' },
                { code: 'vi', name: 'è¶Šå—è¯­', emoji: 'ğŸ‡»ğŸ‡³' }
            ];

            // DOM elements
            const sourceTextEl = document.getElementById('source-text');
            const sourceLangBtn = document.getElementById('source-lang-btn');
            const targetLangBtn = document.getElementById('target-lang-btn');
            const sourceLangText = document.getElementById('source-lang-text');
            const targetLangText = document.getElementById('target-lang-text');
            const swapLangBtn = document.getElementById('swap-lang-btn');
            const sourceLangMenu = document.getElementById('source-lang-menu');
            const targetLangMenu = document.getElementById('target-lang-menu');
            const serviceIconsEl = document.getElementById('service-icons');
            const resultsSection = document.getElementById('results-section');
            const translateBtn = document.getElementById('translate-btn');
            const copyFeedback = document.getElementById('copy-feedback');
            const closeBtn = document.getElementById('close-btn');
            const pinBtn = document.getElementById('pin-btn');
            const settingsBtn = document.getElementById('settings-btn');
            const sourceTtsBtn = document.getElementById('source-tts-btn');
            const sourceCopyBtn = document.getElementById('source-copy-btn');

            // Initialize
            function init() {
                setupTheme();
                buildLanguageMenus();
                updateLanguageDisplays(); // ç¡®ä¿åˆå§‹åŒ–æ—¶è¯­è¨€æ˜¾ç¤ºä¸çŠ¶æ€ä¸€è‡´
                bindEvents();

                // å…ˆåŠ è½½ç¼“å­˜çš„æ¨¡å‹æ•°æ®ä½œä¸ºå ä½æ˜¾ç¤ºï¼ˆå¿«é€Ÿå‘ˆç°ï¼Œæ— å»¶è¿Ÿï¼‰
                loadCachedModels();

                // å°è¯•è·å–åˆå§‹æ•°æ®ï¼ˆå¯èƒ½é€šè¿‡å¤šç§é€”å¾„æ³¨å…¥ï¼‰
                tryGetInitialData();

                // Or receive via postMessage (åç»­æ›´æ–°ç”¨)
                window.addEventListener('message', handleMessage);

                // è‡ªåŠ¨èšç„¦è¾“å…¥æ¡†
                sourceTextEl.focus();
            }

            // ä» localStorage åŠ è½½ç¼“å­˜çš„æ¨¡å‹æ•°æ®
            function loadCachedModels() {
                try {
                    const cached = localStorage.getItem('miniTranslate_cachedModels');
                    if (cached) {
                        const cachedModels = JSON.parse(cached);
                        if (Array.isArray(cachedModels) && cachedModels.length > 0) {
                            allModels = cachedModels;
                            selectedModels = allModels.filter(m => m.isSelected);
                            renderServiceIcons();
                            // ç«‹å³æ¸²æŸ“é€‰ä¸­æ¨¡å‹çš„è¾“å‡ºåŒºåŸŸ
                            renderResults();
                        }
                    }
                } catch (e) {
                    console.warn('åŠ è½½ç¼“å­˜æ¨¡å‹å¤±è´¥:', e);
                }
            }

            // å°è¯•è·å–åˆå§‹æ•°æ®ï¼Œæ”¯æŒå»¶è¿Ÿé‡è¯•
            function tryGetInitialData(retryCount = 0) {
                // å¦‚æœå·²ç»æ¥æ”¶è¿‡æ•°æ®ï¼Œä¸å†é‡å¤å¤„ç†
                if (window.__miniTranslateDataReceived) {
                    return;
                }

                // ä¼˜å…ˆæ£€æŸ¥æ³¨å…¥çš„åˆå§‹æ•°æ®ï¼ˆé€šè¿‡ executeJavaScript æ³¨å…¥ï¼‰
                if (window.__miniTranslateInitData) {
                    window.__miniTranslateDataReceived = true;
                    handleInitialData(window.__miniTranslateInitData);
                    window.__miniTranslateInitData = null;
                    return;
                }

                // å¤‡ç”¨æ–¹æ¡ˆï¼šä» parent window è·å–
                if (window.opener && window.opener.miniTranslateData) {
                    window.__miniTranslateDataReceived = true;
                    handleInitialData(window.opener.miniTranslateData);
                    return;
                }

                // å¦‚æœæ•°æ®è¿˜æ²¡å‡†å¤‡å¥½ï¼ŒçŸ­æš‚ç­‰å¾…åé‡è¯•ï¼ˆæœ€å¤šé‡è¯•30æ¬¡ï¼Œå…±150msï¼Œæ¯5msä¸€æ¬¡ï¼‰
                if (retryCount < 30) {
                    setTimeout(() => tryGetInitialData(retryCount + 1), 5);
                }
            }

            function setupTheme() {
                // Get theme from main app
                const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
            }

            function buildLanguageMenus() {
                const buildMenu = (menu, type) => {
                    menu.innerHTML = languages.map(lang => `
                        <div class="lang-option ${lang.code === (type === 'source' ? sourceLang.code : targetLang.code) ? 'selected' : ''}" 
                             data-code="${lang.code}" data-name="${lang.name}" data-emoji="${lang.emoji}">
                            <span class="lang-emoji">${lang.emoji}</span>
                            <span>${lang.name}</span>
                        </div>
                    `).join('');
                };
                buildMenu(sourceLangMenu, 'source');
                buildMenu(targetLangMenu, 'target');
            }

            function bindEvents() {
                // ä¿å­˜å½“å‰çª—å£ä½ç½®çš„è¾…åŠ©å‡½æ•° - ç›´æ¥ä½¿ç”¨ utools.dbStorage
                function saveWindowPosition() {
                    try {
                        // ä½¿ç”¨ screenX/screenY è·å–çª—å£ä½ç½®
                        const x = window.screenX || window.screenLeft;
                        const y = window.screenY || window.screenTop;
                        if (typeof x === 'number' && typeof y === 'number' && !isNaN(x) && !isNaN(y)) {
                            // ç›´æ¥ä½¿ç”¨ utools.dbStorage ä¿å­˜ï¼ˆåœ¨å­çª—å£ä¸­ä¹Ÿå¯ç”¨ï¼‰
                            if (typeof utools !== 'undefined' && utools.dbStorage) {
                                utools.dbStorage.setItem('miniTranslatePosition', { x, y });
                            }
                        }
                    } catch (e) {
                        // é™é»˜å¤„ç†ä¿å­˜å¤±è´¥
                    }
                }

                // æ‹–åŠ¨ç»“æŸåä¿å­˜ä½ç½®ï¼ˆé€šè¿‡å·¥å…·æ  mouseup äº‹ä»¶ï¼‰
                const toolbar = document.querySelector('.toolbar');
                if (toolbar) {
                    toolbar.addEventListener('mouseup', () => {
                        // çŸ­æš‚å»¶è¿Ÿç¡®ä¿çª—å£ä½ç½®å·²æ›´æ–°
                        setTimeout(saveWindowPosition, 100);
                    });
                }

                // Close button - å…³é—­å‰ä¿å­˜ä½ç½®
                closeBtn.addEventListener('click', () => {
                    saveWindowPosition();
                    window.close();
                });

                // Pin button - ç½®é¡¶åˆ‡æ¢
                pinBtn.addEventListener('click', () => {
                    isPinned = !isPinned;
                    // æ›´æ–°æŒ‰é’®æ ·å¼
                    if (isPinned) {
                        pinBtn.classList.add('pinned');
                    } else {
                        pinBtn.classList.remove('pinned');
                    }
                    // é€šçŸ¥çˆ¶çª—å£æ›´æ–°ç½®é¡¶çŠ¶æ€
                    sendToParent({ type: 'pin', isPinned: isPinned });
                });

                // Settings button - æ‰“å¼€ç¿»è¯‘é»˜è®¤æ¨¡å‹è®¾ç½®
                settingsBtn.addEventListener('click', () => {
                    // ä¿å­˜ä½ç½®
                    saveWindowPosition();
                    // é€šçŸ¥çˆ¶çª—å£æ‰“å¼€è®¾ç½®é¡µé¢ï¼ˆçˆ¶çª—å£ä¼šå¤„ç†æ˜¾ç¤ºä¸»çª—å£å’Œå¯¼èˆªï¼‰
                    sendToParent({ type: 'openSettings', target: 'translate-model' });
                });

                // çª—å£å¤±ç„¦è‡ªåŠ¨å…³é—­ - éç½®é¡¶çŠ¶æ€ä¸‹ï¼Œå…³é—­å‰ä¿å­˜ä½ç½®
                window.addEventListener('blur', () => {
                    if (!isPinned) {
                        saveWindowPosition();
                        window.close();
                    }
                });

                // Source TTS
                sourceTtsBtn.addEventListener('click', () => {
                    if (sourceText) {
                        sendToParent({ type: 'tts', text: sourceText, lang: sourceLang.code });
                    }
                });

                // Source copy
                sourceCopyBtn.addEventListener('click', () => {
                    if (sourceText) {
                        copyToClipboard(sourceText);
                    }
                });

                // Swap languages
                swapLangBtn.addEventListener('click', () => {
                    if (sourceLang.code !== 'auto') {
                        const temp = { ...sourceLang };
                        sourceLang = { ...targetLang };
                        targetLang = temp;
                        updateLanguageDisplays();
                        // Sync with main app
                        sendToParent({ type: 'langChange', sourceLang, targetLang });
                    }
                });

                // Language selectors
                sourceLangBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleMenu(sourceLangMenu, sourceLangBtn);
                });

                targetLangBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleMenu(targetLangMenu, targetLangBtn);
                });

                // Language menu options
                sourceLangMenu.addEventListener('click', (e) => {
                    const option = e.target.closest('.lang-option');
                    if (option) {
                        sourceLang = {
                            code: option.dataset.code,
                            name: option.dataset.name,
                            emoji: option.dataset.emoji
                        };
                        updateLanguageDisplays();
                        hideMenus();
                        sendToParent({ type: 'langChange', sourceLang, targetLang });
                    }
                });

                targetLangMenu.addEventListener('click', (e) => {
                    const option = e.target.closest('.lang-option');
                    if (option) {
                        targetLang = {
                            code: option.dataset.code,
                            name: option.dataset.name,
                            emoji: option.dataset.emoji
                        };
                        updateLanguageDisplays();
                        hideMenus();
                        sendToParent({ type: 'langChange', sourceLang, targetLang });
                    }
                });

                // Close menus on click outside
                document.addEventListener('click', () => {
                    hideMenus();
                });

                // Translate button
                translateBtn.addEventListener('click', () => {
                    // å¦‚æœè¾“å…¥æ¡†ä¸ºç©ºï¼Œå°è¯•è¯»å–å‰ªè´´æ¿
                    if (!sourceText && !sourceTextEl.value.trim()) {
                        try {
                            const { clipboard } = require('electron');
                            const clipText = clipboard.readText();
                            if (clipText && clipText.trim()) {
                                setSourceText(clipText.trim());
                            }
                        } catch (e) {
                            console.warn('è¯»å–å‰ªè´´æ¿å¤±è´¥:', e);
                        }
                    }

                    if (sourceText && !isTranslating) {
                        performTranslation();
                    }
                });

                // Source input event - åŒæ­¥è¾“å…¥æ¡†å†…å®¹åˆ°sourceTextå˜é‡å¹¶å®æ—¶æ£€æµ‹è¯­è¨€
                let detectDebounceTimer = null;
                let isComposing = false; // IMEè¾“å…¥æ³•ç»„åˆçŠ¶æ€ï¼ˆç”¨äºæ£€æµ‹æ‹¼éŸ³è¾“å…¥ä¸­ï¼‰

                // ç›‘å¬è¾“å…¥æ³•ç»„åˆäº‹ä»¶ï¼ˆå¤„ç†æ‹¼éŸ³ã€æ—¥è¯­ç­‰è¾“å…¥æ³•ï¼‰
                sourceTextEl.addEventListener('compositionstart', () => {
                    isComposing = true;
                    // è¾“å…¥æ³•å¼€å§‹ç»„åˆæ—¶ï¼Œæ¸…é™¤è‡ªåŠ¨ç¿»è¯‘å®šæ—¶å™¨
                    clearTimeout(instantTranslateTimer);
                });

                sourceTextEl.addEventListener('compositionend', () => {
                    isComposing = false;
                    // è¾“å…¥æ³•ç»„åˆç»“æŸåï¼Œå¦‚æœå¯ç”¨äº†ç«‹åˆ»è‡ªåŠ¨ç¿»è¯‘ï¼Œé‡æ–°è®¾ç½®å®šæ—¶å™¨
                    if (miniTranslateConfig.instantAutoTranslate && sourceText && sourceText.trim() && !isTranslating) {
                        clearTimeout(instantTranslateTimer);
                        // ä½¿ç”¨ç”¨æˆ·é…ç½®çš„å»¶è¿Ÿæ—¶é—´ï¼ˆé»˜è®¤0.5ç§’ï¼‰
                        const delayMs = (miniTranslateConfig.instantAutoTranslateDelay ?? 0.5) * 1000;
                        instantTranslateTimer = setTimeout(() => {
                            if (sourceText && sourceText.trim() && !isTranslating && !isComposing) {
                                performTranslation();
                            }
                        }, delayMs);
                    }
                });

                sourceTextEl.addEventListener('input', () => {
                    sourceText = sourceTextEl.value;

                    // ä½¿ç”¨é˜²æŠ–è¿›è¡Œå®æ—¶è¯­è¨€æ£€æµ‹
                    clearTimeout(detectDebounceTimer);
                    detectDebounceTimer = setTimeout(() => {
                        if (sourceText && sourceText.length > 1) {
                            detectLanguageFromText(sourceText);
                        }
                    }, 300);

                    // ç«‹åˆ»è‡ªåŠ¨ç¿»è¯‘ï¼šåœæ­¢è¾“å…¥åè‡ªåŠ¨è§¦å‘ç¿»è¯‘
                    // ä»…åœ¨éè¾“å…¥æ³•ç»„åˆçŠ¶æ€ä¸‹è§¦å‘
                    if (miniTranslateConfig.instantAutoTranslate && !isComposing) {
                        clearTimeout(instantTranslateTimer);
                        // ä½¿ç”¨ç”¨æˆ·é…ç½®çš„å»¶è¿Ÿæ—¶é—´ï¼ˆé»˜è®¤0.5ç§’ï¼‰
                        const delayMs = (miniTranslateConfig.instantAutoTranslateDelay ?? 0.5) * 1000;
                        instantTranslateTimer = setTimeout(() => {
                            if (sourceText && sourceText.trim() && !isTranslating && !isComposing) {
                                performTranslation();
                            }
                        }, delayMs);
                    }
                });

                // Enter key in source textarea to translate (æ— éœ€Ctrlï¼ŒShift+Enterç”¨äºæ¢è¡Œ)
                sourceTextEl.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        if (sourceText && !isTranslating) {
                            performTranslation();
                        }
                    }
                });

                // è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹æ—¶è§¦å‘ç¿»è¯‘ï¼ˆä»…åœ¨é…ç½®å¯ç”¨æ—¶ï¼‰
                sourceTextEl.addEventListener('blur', () => {
                    if (miniTranslateConfig.autoTranslateOnBlur && sourceText && sourceText.trim() && !isTranslating) {
                        performTranslation();
                    }
                });

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        window.close();
                    }

                    // Ctrl+C / Cmd+C å¿«æ·é”®å¤åˆ¶ç¿»è¯‘ç»“æœ
                    if ((e.ctrlKey || e.metaKey) && e.key === 'c') {
                        // å¦‚æœæœ‰é€‰ä¸­æ–‡æœ¬ï¼Œä½¿ç”¨ç³»ç»Ÿé»˜è®¤å¤åˆ¶è¡Œä¸º
                        const selection = window.getSelection();
                        if (selection && selection.toString().trim()) {
                            return; // è®©ç³»ç»Ÿå¤„ç†é€‰ä¸­æ–‡æœ¬çš„å¤åˆ¶
                        }

                        // æ²¡æœ‰é€‰ä¸­æ–‡æœ¬æ—¶ï¼Œå¤åˆ¶ç¿»è¯‘ç»“æœ
                        e.preventDefault();
                        handleCopyShortcut();
                    }
                });

                // åŒå‡»å³é”®å¤åˆ¶åŠŸèƒ½ - æ”¯æŒå°çª—ç¿»è¯‘ç»“æœåŒºåŸŸ
                setupDoubleClickRightCopy();
            }

            // è®¾ç½®åŒå‡»å³é”®å¤åˆ¶åŠŸèƒ½
            function setupDoubleClickRightCopy() {
                let rightClickCount = 0;
                let lastRightClickTime = 0;

                document.addEventListener('contextmenu', (e) => {
                    // æ£€æŸ¥æ˜¯å¦åœ¨ç»“æœå¡ç‰‡åŒºåŸŸå†…
                    const resultCard = e.target.closest('.result-card');
                    const resultContent = e.target.closest('.result-content');

                    if (!resultCard && !resultContent) {
                        return; // ä¸åœ¨ç»“æœåŒºåŸŸï¼Œä½¿ç”¨ç³»ç»Ÿé»˜è®¤å³é”®èœå•
                    }

                    e.preventDefault(); // é˜»æ­¢é»˜è®¤å³é”®èœå•

                    const currentTime = Date.now();
                    const timeDiff = currentTime - lastRightClickTime;

                    // å¦‚æœä¸¤æ¬¡å³é”®ç‚¹å‡»é—´éš”å°äº500msï¼Œè®¤ä¸ºæ˜¯åŒå‡»å³é”®
                    if (timeDiff < 500 && rightClickCount === 1) {
                        // é‡ç½®è®¡æ•°å™¨
                        rightClickCount = 0;
                        lastRightClickTime = 0;

                        // æ£€æŸ¥é…ç½®æ˜¯å¦å¯ç”¨äº†æ­¤åŠŸèƒ½
                        if (!miniTranslateConfig.enableDoubleClickRightCopy) {
                            return; // å¦‚æœåŠŸèƒ½è¢«ç¦ç”¨ï¼Œä¸æ‰§è¡Œå¤åˆ¶
                        }

                        // è·å–å¯¹åº”çš„ç¿»è¯‘ç»“æœå¹¶å¤åˆ¶
                        const card = resultContent ? resultContent.closest('.result-card') : resultCard;
                        if (card) {
                            const key = card.dataset.key;
                            const result = translateResults[key];
                            if (result && result.text) {
                                copyToClipboard(result.text);
                                showCopyFeedbackOnElement(card);

                                // å¦‚æœé…ç½®äº†å¤åˆ¶åè‡ªåŠ¨å…³é—­
                                if (miniTranslateConfig.autoCloseOnCopy) {
                                    setTimeout(() => {
                                        window.close();
                                    }, 300);
                                }
                            }
                        }
                    } else {
                        // ç¬¬ä¸€æ¬¡å³é”®ç‚¹å‡»æˆ–è¶…æ—¶é‡ç½®
                        rightClickCount = 1;
                        lastRightClickTime = currentTime;

                        // è®¾ç½®è¶…æ—¶ï¼Œå¦‚æœ500mså†…æ²¡æœ‰ç¬¬äºŒæ¬¡å³é”®ç‚¹å‡»ï¼Œé‡ç½®è®¡æ•°å™¨
                        setTimeout(() => {
                            if (rightClickCount === 1 && (Date.now() - lastRightClickTime) >= 500) {
                                rightClickCount = 0;
                                lastRightClickTime = 0;
                            }
                        }, 500);
                    }
                });
            }

            // æ˜¾ç¤ºå¤åˆ¶åé¦ˆæ•ˆæœï¼ˆåœ¨å…ƒç´ ä¸Šï¼‰
            function showCopyFeedbackOnElement(element) {
                // ä¿å­˜åŸå§‹èƒŒæ™¯è‰²
                const originalBg = element.style.backgroundColor;
                const originalTransition = element.style.transition;

                // è®¾ç½®ä¸€ä¸ªçŸ­æš‚çš„èƒŒæ™¯è‰²å˜åŒ–ä½œä¸ºåé¦ˆ
                element.style.backgroundColor = 'rgba(59, 130, 246, 0.15)';
                element.style.transition = 'background-color 0.2s ease';

                // 200msåæ¢å¤åŸå§‹èƒŒæ™¯è‰²
                setTimeout(() => {
                    element.style.backgroundColor = originalBg;
                    setTimeout(() => {
                        element.style.transition = originalTransition;
                    }, 200);
                }, 200);
            }

            // å¤„ç†å¿«æ·é”®å¤åˆ¶ç¿»è¯‘ç»“æœ
            function handleCopyShortcut() {
                let textToCopy = null;

                if (miniTranslateConfig.copyFirstModel && selectedModels.length > 0) {
                    // é»˜è®¤å¤åˆ¶æ¨¡å‹ä¸€ç»“æœ
                    const firstModel = selectedModels[0];
                    const firstKey = `${firstModel.service}_${firstModel.model}`;
                    const firstResult = translateResults[firstKey];
                    if (firstResult && firstResult.status === 'completed' && firstResult.text) {
                        textToCopy = firstResult.text;
                    }
                } else {
                    // å¤åˆ¶ç¬¬ä¸€ä¸ªæœ‰ç»“æœçš„æ¨¡å‹
                    for (const model of selectedModels) {
                        const key = `${model.service}_${model.model}`;
                        const result = translateResults[key];
                        if (result && result.status === 'completed' && result.text) {
                            textToCopy = result.text;
                            break;
                        }
                    }
                }

                if (textToCopy) {
                    copyToClipboard(textToCopy);

                    // å¦‚æœé…ç½®äº†å¤åˆ¶åè‡ªåŠ¨å…³é—­
                    if (miniTranslateConfig.autoCloseOnCopy) {
                        setTimeout(() => {
                            window.close();
                        }, 300); // ç¨å¾®å»¶è¿Ÿï¼Œè®©ç”¨æˆ·çœ‹åˆ°å¤åˆ¶æˆåŠŸæç¤º
                    }
                }
            }

            function toggleMenu(menu, btn) {
                const isOpen = menu.classList.contains('show');
                hideMenus();
                if (!isOpen) {
                    const rect = btn.getBoundingClientRect();
                    menu.style.top = rect.bottom + 4 + 'px';
                    menu.style.left = rect.left + 'px';
                    menu.classList.add('show');
                }
            }

            function hideMenus() {
                sourceLangMenu.classList.remove('show');
                targetLangMenu.classList.remove('show');
            }

            function updateLanguageDisplays() {
                sourceLangBtn.querySelector('.lang-emoji').textContent = sourceLang.emoji;
                // å…¼å®¹ name å’Œ label ä¸¤ç§å±æ€§å
                sourceLangText.textContent = sourceLang.name || sourceLang.label || '';
                targetLangBtn.querySelector('.lang-emoji').textContent = targetLang.emoji;
                targetLangText.textContent = targetLang.name || targetLang.label || '';
                buildLanguageMenus();
            }

            function setSourceText(text) {
                sourceText = text;
                sourceTextEl.value = text; // ä½¿ç”¨.valueè€Œä¸æ˜¯.textContentå› ä¸ºæ˜¯textarea
            }

            function setDetectedLanguage(lang) {
                if (lang) {
                    detectedLangEl.textContent = lang;
                    detectedLangEl.style.display = 'inline-flex';
                } else {
                    detectedLangEl.style.display = 'none';
                }
            }

            // å®æ—¶è¯­è¨€æ£€æµ‹å‡½æ•°
            function detectLanguageFromText(text) {
                if (!text || text.length < 2) return;

                // UnicodeèŒƒå›´æ£€æµ‹
                const counts = { zh: 0, ja: 0, ko: 0, ru: 0, ar: 0, latin: 0 };
                const sampleText = text.substring(0, 200);

                for (let i = 0; i < sampleText.length; i++) {
                    const char = sampleText.charCodeAt(i);
                    if ((char >= 0x4e00 && char <= 0x9fff) || (char >= 0x3400 && char <= 0x4dbf)) {
                        counts.zh++;
                    } else if ((char >= 0x3040 && char <= 0x309f) || (char >= 0x30a0 && char <= 0x30ff)) {
                        counts.ja++;
                    } else if (char >= 0xac00 && char <= 0xd7af) {
                        counts.ko++;
                    } else if (char >= 0x0400 && char <= 0x04ff) {
                        counts.ru++;
                    } else if (char >= 0x0600 && char <= 0x06ff) {
                        counts.ar++;
                    } else if ((char >= 0x0041 && char <= 0x005a) || (char >= 0x0061 && char <= 0x007a)) {
                        counts.latin++;
                    }
                }

                const maxCount = Math.max(...Object.values(counts));
                if (maxCount === 0) return;

                const maxType = Object.keys(counts).find(key => counts[key] === maxCount);
                let newSourceLang = null;
                let newTargetLang = null;
                let detectedName = null;

                // æ ¹æ®æ£€æµ‹ç»“æœè®¾ç½®è¯­è¨€
                if (maxType === 'zh') {
                    newSourceLang = { code: 'zh-cn', name: 'ä¸­æ–‡ (ç®€)', emoji: 'ğŸ‡¨ğŸ‡³' };
                    newTargetLang = { code: 'en-us', name: 'è‹±è¯­', emoji: 'ğŸ‡¬ğŸ‡§' };
                    detectedName = 'ä¸­æ–‡';
                } else if (maxType === 'ja') {
                    newSourceLang = { code: 'ja-jp', name: 'æ—¥è¯­', emoji: 'ğŸ‡¯ğŸ‡µ' };
                    newTargetLang = { code: 'zh-cn', name: 'ä¸­æ–‡ (ç®€)', emoji: 'ğŸ‡¨ğŸ‡³' };
                    detectedName = 'æ—¥è¯­';
                } else if (maxType === 'ko') {
                    newSourceLang = { code: 'ko-kr', name: 'éŸ©è¯­', emoji: 'ğŸ‡°ğŸ‡·' };
                    newTargetLang = { code: 'zh-cn', name: 'ä¸­æ–‡ (ç®€)', emoji: 'ğŸ‡¨ğŸ‡³' };
                    detectedName = 'éŸ©è¯­';
                } else if (maxType === 'latin') {
                    newSourceLang = { code: 'en-us', name: 'è‹±è¯­', emoji: 'ğŸ‡¬ğŸ‡§' };
                    newTargetLang = { code: 'zh-cn', name: 'ä¸­æ–‡ (ç®€)', emoji: 'ğŸ‡¨ğŸ‡³' };
                    detectedName = 'è‹±è¯­';
                } else if (maxType === 'ru') {
                    newSourceLang = { code: 'ru-ru', name: 'ä¿„è¯­', emoji: 'ğŸ‡·ğŸ‡º' };
                    newTargetLang = { code: 'zh-cn', name: 'ä¸­æ–‡ (ç®€)', emoji: 'ğŸ‡¨ğŸ‡³' };
                    detectedName = 'ä¿„è¯­';
                } else if (maxType === 'ar') {
                    newSourceLang = { code: 'ar-ar', name: 'é˜¿æ‹‰ä¼¯è¯­', emoji: 'ğŸ‡¸ğŸ‡¦' };
                    newTargetLang = { code: 'zh-cn', name: 'ä¸­æ–‡ (ç®€)', emoji: 'ğŸ‡¨ğŸ‡³' };
                    detectedName = 'é˜¿æ‹‰ä¼¯è¯­';
                }

                // æ›´æ–°è¯­è¨€é€‰æ‹©å™¨
                if (newSourceLang && newSourceLang.code !== sourceLang.code) {
                    sourceLang = newSourceLang;
                    if (newTargetLang) {
                        targetLang = newTargetLang;
                    }
                    updateLanguageDisplays();
                }
            }

            function setModels(models, forceRefreshSelection = false) {
                // models now contains all 4 models with isSelected property
                allModels = models || [];

                // å¦‚æœéœ€è¦å¼ºåˆ¶åˆ·æ–°é€‰ä¸­çŠ¶æ€ï¼ˆä¾‹å¦‚çª—å£é‡æ–°æ˜¾ç¤ºæ—¶ï¼‰ï¼Œä»utools.dbStorageè¯»å–æœ€æ–°çŠ¶æ€
                if (forceRefreshSelection && typeof utools !== 'undefined' && utools.dbStorage) {
                    try {
                        const savedMiniSelection = utools.dbStorage.getItem('miniTranslate_selectedModels');
                        if (savedMiniSelection && Array.isArray(savedMiniSelection) && savedMiniSelection.length > 0) {
                            // ä½¿ç”¨ dbStorage ä¸­çš„æœ€æ–°é€‰ä¸­çŠ¶æ€è¦†ç›–ä¼ å…¥çš„ isSelected
                            allModels.forEach((model, index) => {
                                const modelKey = `${model.service}:${model.model}`;
                                model.isSelected = savedMiniSelection.includes(modelKey);
                            });
                        }
                        // æ— è®ºæ˜¯å¦æœ‰ä¿å­˜çš„çŠ¶æ€ï¼Œéƒ½ç¡®ä¿è‡³å°‘æœ‰ä¸€ä¸ªæ¨¡å‹è¢«é€‰ä¸­
                        const anySelected = allModels.some(m => m.isSelected);
                        if (!anySelected && allModels.length > 0) {
                            allModels[0].isSelected = true;
                        }
                    } catch (e) {
                        console.warn('è¯»å–å°çª—æ¨¡å‹é€‰ä¸­çŠ¶æ€å¤±è´¥:', e);
                    }
                }

                // ç¡®ä¿æ— è®ºå¦‚ä½•éƒ½è‡³å°‘æœ‰ä¸€ä¸ªæ¨¡å‹è¢«é€‰ä¸­ï¼ˆå¤„ç†é¦–æ¬¡æ‰“å¼€æˆ–å¼‚å¸¸æƒ…å†µï¼‰
                const anySelected = allModels.some(m => m.isSelected);
                if (!anySelected && allModels.length > 0) {
                    allModels[0].isSelected = true;
                }

                // selectedModels are those with isSelected=true (for translation)
                selectedModels = allModels.filter(m => m.isSelected);

                // ä¿å­˜æ¨¡å‹æ•°æ®åˆ° localStorageï¼Œä¾›ä¸‹æ¬¡æ‰“å¼€æ—¶ä½œä¸ºå ä½æ˜¾ç¤º
                try {
                    localStorage.setItem('miniTranslate_cachedModels', JSON.stringify(allModels));
                } catch (e) {
                    console.warn('ä¿å­˜æ¨¡å‹ç¼“å­˜å¤±è´¥:', e);
                }

                renderServiceIcons();
                // ç«‹å³æ¸²æŸ“é€‰ä¸­æ¨¡å‹çš„ç©ºç»“æœå¡ç‰‡
                renderResults();
            }

            function renderServiceIcons() {
                // æ¸²æŸ“æ‰€æœ‰æ¨¡å‹ï¼ˆæœ€å¤š4ä¸ªï¼‰ï¼Œæ ¹æ®isSelectedæ˜¾ç¤ºé€‰ä¸­çŠ¶æ€
                serviceIconsEl.innerHTML = allModels.map((model, index) => {
                    const iconContent = model.iconHtml
                        ? `<div class="service-icon-svg">${model.iconHtml}</div>`
                        : `<img src="${getModelIcon(model.service)}" alt="${model.service}" onerror="this.style.display='none'">`;
                    const selectedClass = model.isSelected ? 'selected' : '';
                    return `
                        <div class="service-icon ${selectedClass}" data-index="${index}" data-service="${model.service}" data-model="${model.model}" title="${model.name || model.model}">
                            ${iconContent}
                        </div>
                    `;
                }).join('');

                // ç»‘å®šç‚¹å‡»äº‹ä»¶ç”¨äºåˆ‡æ¢é€‰ä¸­çŠ¶æ€
                document.querySelectorAll('.service-icon').forEach(icon => {
                    icon.addEventListener('click', (e) => {
                        const index = parseInt(e.currentTarget.dataset.index);
                        toggleModelSelection(index);
                    });
                });
            }

            function toggleModelSelection(index) {
                if (index < 0 || index >= allModels.length) return;

                const model = allModels[index];
                const currentlySelected = model.isSelected;

                // è®¡ç®—å½“å‰é€‰ä¸­çš„æ¨¡å‹æ•°é‡
                const selectedCount = allModels.filter(m => m.isSelected).length;

                if (currentlySelected && selectedCount <= 1) {
                    // è‡³å°‘ä¿ç•™ä¸€ä¸ªé€‰ä¸­çš„æ¨¡å‹
                    return;
                }

                // åˆ‡æ¢é€‰ä¸­çŠ¶æ€
                model.isSelected = !currentlySelected;

                // æ›´æ–°selectedModelsåˆ—è¡¨
                selectedModels = allModels.filter(m => m.isSelected);

                // é‡æ–°æ¸²æŸ“å›¾æ ‡
                renderServiceIcons();
                // ç«‹å³æ¸²æŸ“é€‰ä¸­æ¨¡å‹çš„ç©ºç»“æœå¡ç‰‡
                renderResults();

                // ä¿å­˜åˆ°å°çª—ç¿»è¯‘ç‹¬ç«‹çš„å­˜å‚¨ï¼ˆä¸å†åŒæ­¥åˆ°ä¸»çª—å£ï¼‰
                try {
                    const selectedKeys = allModels
                        .filter(m => m.isSelected)
                        .map(m => `${m.service}:${m.model}`);
                    if (typeof utools !== 'undefined' && utools.dbStorage) {
                        utools.dbStorage.setItem('miniTranslate_selectedModels', selectedKeys);
                    }
                    // åŒæ—¶æ›´æ–° localStorage ç¼“å­˜
                    localStorage.setItem('miniTranslate_cachedModels', JSON.stringify(allModels));
                } catch (e) {
                    console.warn('ä¿å­˜æ¨¡å‹é€‰æ‹©çŠ¶æ€å¤±è´¥:', e);
                }
            }

            function getModelIcon(service) {
                // å›¾æ ‡æ–‡ä»¶ç›¸å¯¹äºassetsç›®å½•
                const iconMap = {
                    'openai': 'icons/openai-icon.svg',
                    'anthropic': 'icons/anthropic-icon.svg',
                    'gemini': 'icons/google-icon.svg',
                    'google': 'icons/google-icon.svg',
                    'deepseek': 'icons/openai-icon.svg',
                    'baidu': 'icons/baidu-icon.svg',
                    'tencent': 'icons/tencent-icon.svg',
                    'volcengine': 'icons/bytedance-icon.svg',
                    'bytedance': 'icons/bytedance-icon.svg',
                    'baidu_translate': 'icons/baidu-icon.svg',
                    'youdao': 'icons/baidu-icon.svg',
                    'alibaba': 'icons/aliyun-icon.svg',
                    'aliyun': 'icons/aliyun-icon.svg',
                    'zhipu': 'icons/zhipu-icon.svg',
                    'utools': 'icons/utools-icon.svg',
                    'qwen': 'icons/aliyun-icon.svg'
                };
                return iconMap[service] || 'logo.png';
            }

            function performTranslation() {
                if (!sourceText || isTranslating) return;

                isTranslating = true;
                translateBtn.disabled = true;

                // è®¾ç½®ç¿»è¯‘è¶…æ—¶ï¼ˆ30ç§’ï¼‰ï¼Œé˜²æ­¢æ°¸ä¹…åŠ è½½çŠ¶æ€
                if (window.translationTimeoutTimer) {
                    clearTimeout(window.translationTimeoutTimer);
                }
                window.translationTimeoutTimer = setTimeout(() => {
                    if (isTranslating) {
                        console.warn('[å°çª—ç¿»è¯‘] ç¿»è¯‘è¶…æ—¶ï¼Œé‡ç½®çŠ¶æ€');
                        isTranslating = false;
                        translateBtn.disabled = false;
                        renderResults(); // æ¸…é™¤åŠ è½½çŠ¶æ€
                    }
                }, 30000);
                // Clear the object properties instead of reassigning to maintain window.translateResults reference
                Object.keys(translateResults).forEach(key => delete translateResults[key]);
                window.translateResults = translateResults;  // Ensure window reference is synced

                // Show loading state for each model
                renderResults(true);

                // Send translation request to parent
                sendToParent({
                    type: 'translate',
                    text: sourceText,
                    sourceLang: sourceLang,
                    targetLang: targetLang,
                    models: selectedModels
                });
            }

            function renderResults(loading = false) {
                if (selectedModels.length === 0) {
                    resultsSection.innerHTML = `
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="m5 8 6 6"/>
                                <path d="m4 14 6-6 2-3"/>
                                <path d="M2 5h12"/>
                                <path d="M7 2h1"/>
                                <path d="m22 22-5-10-5 10"/>
                                <path d="M14 18h6"/>
                            </svg>
                            <span>è¯·é€‰æ‹©ç¿»è¯‘æ¨¡å‹</span>
                        </div>
                    `;
                    return;
                }

                resultsSection.innerHTML = selectedModels.map((model, index) => {
                    const key = `${model.service}_${model.model}`;
                    const result = translateResults[key];
                    const isLoading = loading || (result && result.status === 'streaming');
                    const hasError = result && result.status === 'failed';
                    const hasResult = result && result.status === 'completed' && result.text;

                    // ä½¿ç”¨ä¸»çª—å£ä¼ é€’çš„å›¾æ ‡ï¼Œå¦‚æœæ²¡æœ‰åˆ™å›é€€åˆ°æœ¬åœ°å›¾ç‰‡
                    const iconContent = model.iconHtml
                        ? `<div class="result-service-icon-svg">${model.iconHtml}</div>`
                        : `<img src="${getModelIcon(model.service)}" alt="${model.service}" onerror="this.style.display='none'">`;

                    // åªæœ‰åœ¨ç¿»è¯‘ä¸­æˆ–æœ‰ç»“æœæ—¶æ‰å±•å¼€
                    const shouldExpand = isLoading || hasResult || hasError;

                    return `
                        <div class="result-card ${shouldExpand ? 'expanded' : ''}" data-key="${key}">
                            <div class="result-header">
                                <div class="result-service-icon">
                                    ${iconContent}
                                </div>
                                <span class="result-service-name">${model.name || model.model}</span>
                                <div class="result-status">
                                    ${isLoading ? '<div class="loading-spinner"></div>' : ''}
                                    <button class="result-action-btn result-tts" data-key="${key}" title="æœ—è¯»">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polygon points="11 5,6 9,2 9,2 15,6 15,11 19,11 5"/>
                                            <path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>
                                        </svg>
                                    </button>
                                    <button class="result-action-btn result-copy" data-key="${key}" title="å¤åˆ¶">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <rect width="14" height="14" x="8" y="8" rx="2"/>
                                            <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/>
                                        </svg>
                                    </button>
                                    <svg class="expand-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M6 9l6 6 6-6"/>
                                    </svg>
                                </div>
                            </div>
                            <div class="result-content">
                                ${hasError ? `<span style="color: var(--error-color)">ç¿»è¯‘å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}</span>` : ''}
                                ${hasResult ? result.text : ''}
                                ${isLoading ? 'ç¿»è¯‘ä¸­...' : ''}
                                ${!hasResult && !hasError && !isLoading ? '<span class="result-placeholder">ç¿»è¯‘ç»“æœæ˜¾ç¤ºåœ¨è¿™é‡Œ......</span>' : ''}
                            </div>
                        </div>
                    `;
                }).join('');

                // Bind result events
                bindResultEvents();

                // Auto-adjust window height based on content
                requestAnimationFrame(() => adjustWindowHeight());
            }

            function bindResultEvents() {
                // Toggle expand/collapse
                document.querySelectorAll('.result-header').forEach(header => {
                    header.addEventListener('click', (e) => {
                        if (!e.target.closest('.result-action-btn')) {
                            header.closest('.result-card').classList.toggle('expanded');
                            // Adjust window height after expand/collapse
                            requestAnimationFrame(() => adjustWindowHeight());
                        }
                    });
                });

                // Copy buttons
                document.querySelectorAll('.result-copy').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const key = btn.dataset.key;
                        const result = translateResults[key];
                        if (result && result.text) {
                            copyToClipboard(result.text);
                            // å¦‚æœé…ç½®äº†å¤åˆ¶åè‡ªåŠ¨å…³é—­
                            if (miniTranslateConfig.autoCloseOnCopy) {
                                setTimeout(() => {
                                    window.close();
                                }, 300); // ç¨å¾®å»¶è¿Ÿï¼Œè®©ç”¨æˆ·çœ‹åˆ°å¤åˆ¶æˆåŠŸæç¤º
                            }
                        }
                    });
                });

                // TTS buttons
                document.querySelectorAll('.result-tts').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const key = btn.dataset.key;
                        const result = translateResults[key];
                        if (result && result.text) {
                            sendToParent({ type: 'tts', text: result.text, lang: targetLang.code });
                        }
                    });
                });
            }

            function updateResult(modelKey, result) {
                translateResults[modelKey] = result;
                window.translateResults = translateResults;  // Keep window reference synced

                // Update individual card
                const card = document.querySelector(`.result-card[data-key="${modelKey}"]`);
                if (card) {
                    const contentEl = card.querySelector('.result-content');
                    const statusEl = card.querySelector('.result-status');

                    if (result.status === 'streaming') {
                        contentEl.textContent = result.text || 'ç¿»è¯‘ä¸­...';
                        if (!statusEl.querySelector('.loading-spinner')) {
                            statusEl.insertAdjacentHTML('afterbegin', '<div class="loading-spinner"></div>');
                        }
                    } else if (result.status === 'completed') {
                        contentEl.textContent = result.text || '';
                        const spinner = statusEl.querySelector('.loading-spinner');
                        if (spinner) spinner.remove();
                    } else if (result.status === 'failed') {
                        contentEl.innerHTML = `<span style="color: var(--error-color)">ç¿»è¯‘å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}</span>`;
                        const spinner = statusEl.querySelector('.loading-spinner');
                        if (spinner) spinner.remove();
                    }

                    // Adjust window height after content change
                    requestAnimationFrame(() => adjustWindowHeight());
                }
            }

            function handleTranslationComplete() {
                // æ¸…é™¤ç¿»è¯‘è¶…æ—¶å®šæ—¶å™¨
                if (window.translationTimeoutTimer) {
                    clearTimeout(window.translationTimeoutTimer);
                    window.translationTimeoutTimer = null;
                }
                isTranslating = false;
                translateBtn.disabled = false;
            }

            function copyToClipboard(text) {
                // ä½¿ç”¨require('electron')çš„clipboard
                try {
                    const { clipboard } = require('electron');
                    clipboard.writeText(text);
                    showCopyFeedback();
                } catch (e) {
                    // å›é€€åˆ°navigator API
                    navigator.clipboard.writeText(text).then(() => {
                        showCopyFeedback();
                    }).catch(console.error);
                }
            }

            // Toasté€šçŸ¥ç³»ç»Ÿ - ä¸ä¸»æ’ä»¶ä¿æŒä¸€è‡´
            function showNotification(message, type = 'success', duration = 2000) {
                const container = document.getElementById('toast-container');
                if (!container) return;

                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;

                // æ’å…¥åˆ°å®¹å™¨å¼€å¤´
                container.insertBefore(toast, container.firstChild);

                // è§¦å‘æ˜¾ç¤ºåŠ¨ç”»
                requestAnimationFrame(() => {
                    toast.classList.add('show');
                });

                // è‡ªåŠ¨éšè—
                const hideTimeout = setTimeout(() => hideToast(toast), duration);

                // ç‚¹å‡»éšè—
                toast.addEventListener('click', () => {
                    clearTimeout(hideTimeout);
                    hideToast(toast);
                });

                return toast;
            }

            function hideToast(toast) {
                if (!toast || !toast.parentNode) return;

                toast.classList.remove('show');
                toast.classList.add('hide');

                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }

            // å…¼å®¹æ—§çš„showCopyFeedbackè°ƒç”¨
            function showCopyFeedback() {
                showNotification('å·²å¤åˆ¶', 'success', 1500);
            }

            // è¯·æ±‚é˜Ÿåˆ— - å­˜å‚¨å¾…å¤„ç†çš„è¯·æ±‚ä¾›ä¸»çª—å£è½®è¯¢
            window.miniTranslateRequestQueue = [];

            function sendToParent(data) {
                // å°†è¯·æ±‚åŠ å…¥é˜Ÿåˆ—ï¼Œä¸»çª—å£ä¼šé€šè¿‡executeJavaScriptè½®è¯¢è¿™ä¸ªé˜Ÿåˆ—
                window.miniTranslateRequestQueue.push(data);
            }

            // ä¸»çª—å£è½®è¯¢ç”¨çš„API
            window.getMiniTranslateRequests = function () {
                const requests = window.miniTranslateRequestQueue.slice();
                window.miniTranslateRequestQueue = [];
                return requests;
            };

            function receiveDataFromParent() {
                // Try to get initial data from parent window
                if (window.opener && window.opener.miniTranslateData) {
                    const data = window.opener.miniTranslateData;
                    handleInitialData(data);
                }
            }

            function handleInitialData(data) {
                // ä½¿ç”¨ä¸»çª—å£ä¼ é€’è¿‡æ¥çš„è¯­è¨€åˆ—è¡¨
                if (data.languages && data.languages.length > 0) {
                    languages = data.languages;
                    buildLanguageMenus();
                }

                // è¾…åŠ©å‡½æ•°ï¼šæ ‡å‡†åŒ–è¯­è¨€å¯¹è±¡æ ¼å¼
                const normalizeLangObject = (lang) => {
                    if (!lang) return null;
                    return {
                        code: lang.code || lang.langCode,
                        name: lang.name || lang.label,
                        emoji: lang.emoji
                    };
                };

                if (data.sourceLang) {
                    const normalized = normalizeLangObject(data.sourceLang);
                    if (normalized && normalized.code && normalized.name) {
                        sourceLang = normalized;
                    }
                    updateLanguageDisplays();
                }
                if (data.targetLang) {
                    const normalized = normalizeLangObject(data.targetLang);
                    if (normalized && normalized.code && normalized.name) {
                        targetLang = normalized;
                    }
                    updateLanguageDisplays();
                }
                if (data.models) {
                    // ä¼ å…¥ forceRefreshSelection=true ä»¥ä» utools.dbStorage è¯»å–æœ€æ–°çš„æ¨¡å‹å¯ç”¨çŠ¶æ€
                    // è¿™ç¡®ä¿äº†å³ä½¿é¢„åˆ›å»ºçª—å£å·²ç»åŠ è½½äº†æ—§çš„ localStorage ç¼“å­˜ï¼Œä¹Ÿä¼šä½¿ç”¨æœ€æ–°çš„çŠ¶æ€
                    setModels(data.models, true);
                }
                if (data.theme) {
                    document.documentElement.setAttribute('data-theme', data.theme);
                }

                // æ¥æ”¶å°çª—ç¿»è¯‘é…ç½®
                if (data.miniTranslateConfig) {
                    if (data.miniTranslateConfig.autoTranslateOnBlur !== undefined) {
                        miniTranslateConfig.autoTranslateOnBlur = data.miniTranslateConfig.autoTranslateOnBlur;
                    }
                    if (data.miniTranslateConfig.instantAutoTranslate !== undefined) {
                        miniTranslateConfig.instantAutoTranslate = data.miniTranslateConfig.instantAutoTranslate;
                    }
                    if (data.miniTranslateConfig.instantAutoTranslateDelay !== undefined) {
                        miniTranslateConfig.instantAutoTranslateDelay = data.miniTranslateConfig.instantAutoTranslateDelay;
                    }
                    if (data.miniTranslateConfig.autoCloseOnCopy !== undefined) {
                        miniTranslateConfig.autoCloseOnCopy = data.miniTranslateConfig.autoCloseOnCopy;
                    }
                    if (data.miniTranslateConfig.copyFirstModel !== undefined) {
                        miniTranslateConfig.copyFirstModel = data.miniTranslateConfig.copyFirstModel;
                    }
                    if (data.miniTranslateConfig.enableDoubleClickRightCopy !== undefined) {
                        miniTranslateConfig.enableDoubleClickRightCopy = data.miniTranslateConfig.enableDoubleClickRightCopy;
                    }
                }

                // å¤„ç†ä¼ å…¥çš„æ–‡æœ¬ï¼šå†™å…¥è¾“å…¥æ¡†å¹¶åŒæ­¥åˆ° sourceText å˜é‡
                if (data.text && data.text.trim()) {
                    sourceText = data.text.trim();
                    sourceTextEl.value = sourceText;

                    // è§¦å‘è¯­è¨€æ£€æµ‹
                    if (sourceText.length > 1) {
                        detectLanguageFromText(sourceText);
                    }

                    // å¦‚æœè®¾ç½®äº†è‡ªåŠ¨ç¿»è¯‘ï¼Œå»¶è¿Ÿæ‰§è¡Œç¿»è¯‘ï¼ˆç¡®ä¿æ¨¡å‹å·²åŠ è½½ï¼‰
                    if (data.autoTranslate) {
                        setTimeout(() => {
                            // æ£€æŸ¥æ¨¡å‹æ˜¯å¦å·²åŠ è½½
                            if (sourceText && !isTranslating && selectedModels.length > 0) {
                                performTranslation();
                            } else if (sourceText && !isTranslating) {
                                // å¦‚æœæ¨¡å‹è¿˜æ²¡åŠ è½½ï¼Œå†ç­‰å¾…ä¸€ä¼š
                                setTimeout(() => {
                                    if (sourceText && !isTranslating && selectedModels.length > 0) {
                                        performTranslation();
                                    }
                                }, 300);
                            }
                        }, 200);
                    }
                }
            }

            function handleMessage(event) {
                const data = event.data;
                if (!data || !data.type) return;

                switch (data.type) {
                    case 'init':
                        handleInitialData(data);
                        break;
                    case 'updateResult':
                        updateResult(data.modelKey, data.result);
                        break;
                    case 'translationComplete':
                        handleTranslationComplete();
                        break;
                    case 'updateModels':
                        setModels(data.models, true);
                        break;
                    case 'updateTheme':
                        document.documentElement.setAttribute('data-theme', data.theme);
                        break;
                    case 'updateLanguage':
                        if (data.sourceLang) {
                            // å…¼å®¹ langCode/code å’Œ name/label ä¸¤ç§å±æ€§å
                            sourceLang = {
                                code: data.sourceLang.code || data.sourceLang.langCode,
                                name: data.sourceLang.name || data.sourceLang.label,
                                emoji: data.sourceLang.emoji
                            };
                        }
                        if (data.targetLang) {
                            targetLang = {
                                code: data.targetLang.code || data.targetLang.langCode,
                                name: data.targetLang.name || data.targetLang.label,
                                emoji: data.targetLang.emoji
                            };
                        }
                        updateLanguageDisplays();
                        // æ˜¾ç¤ºæ£€æµ‹åˆ°çš„è¯­è¨€æ ‡ç­¾
                        if (data.detectedLang) {
                            setDetectedLanguage(data.detectedLang);
                        }
                        break;
                }
            }

            // Expose API for parent window
            // Auto-adjust window height based on content
            const MIN_WINDOW_HEIGHT = 280;
            const MAX_WINDOW_HEIGHT = 800;
            let lastHeight = 0;
            let isAdjusting = false;

            function adjustWindowHeight() {
                // ç›´æ¥æ‰§è¡Œï¼Œä¸ä½¿ç”¨é˜²æŠ–ä»¥è·å¾—å³æ—¶å“åº”
                if (!isAdjusting) {
                    isAdjusting = true;
                    performHeightAdjustment();
                    // ä½¿ç”¨ requestAnimationFrame ç¡®ä¿ä¸‹ä¸€å¸§å¯ä»¥å†æ¬¡è°ƒæ•´
                    requestAnimationFrame(() => {
                        isAdjusting = false;
                    });
                }
            }

            function performHeightAdjustment() {
                try {
                    // Calculate the total content height
                    const toolbar = document.querySelector('.toolbar');
                    const sourceSection = document.querySelector('.source-section');
                    const controlsSection = document.querySelector('.controls-section');
                    const resultsSection = document.getElementById('results-section');

                    if (!toolbar || !sourceSection || !controlsSection || !resultsSection) return;

                    // Get heights of each section
                    const toolbarHeight = toolbar.offsetHeight;
                    const sourceHeight = sourceSection.offsetHeight;
                    const controlsHeight = controlsSection.offsetHeight;

                    // è·å–ç»“æœåŒºåŸŸçš„å®é™…å†…å®¹é«˜åº¦
                    let resultsHeight = 0;
                    const resultCards = resultsSection.querySelectorAll('.result-card');
                    if (resultCards.length > 0) {
                        resultCards.forEach(card => {
                            resultsHeight += card.offsetHeight + 10; // 10px margin-bottom
                        });
                        resultsHeight += 6; // bottom padding
                    } else {
                        // empty state height
                        const emptyState = resultsSection.querySelector('.empty-state');
                        if (emptyState) {
                            resultsHeight = emptyState.offsetHeight + 24;
                        } else {
                            resultsHeight = 80;
                        }
                    }

                    // Add margins: 8px between controls and source, 8px between controls and results
                    const margins = 8 + 8;

                    // Calculate total content height
                    let totalHeight = toolbarHeight + sourceHeight + controlsHeight + resultsHeight + margins;

                    // Clamp to min/max range
                    totalHeight = Math.max(MIN_WINDOW_HEIGHT, Math.min(MAX_WINDOW_HEIGHT, totalHeight));

                    // Only resize if height changed (with small threshold to avoid micro-adjustments)
                    if (Math.abs(totalHeight - lastHeight) > 5) {
                        lastHeight = totalHeight;

                        // ç›´æ¥è°ƒç”¨ Electron API è°ƒæ•´çª—å£å¤§å°ï¼ˆå¦‚æœå¯ç”¨ï¼‰
                        try {
                            const { ipcRenderer } = require('electron');
                            // å°è¯•é€šè¿‡ utools API è°ƒæ•´
                            if (window.utools && window.utools.setWindowSize) {
                                window.utools.setWindowSize(420, Math.round(totalHeight));
                            } else {
                                // å›é€€åˆ°é€šè¿‡çˆ¶çª—å£æ¶ˆæ¯
                                sendToParent({
                                    type: 'resizeWindow',
                                    height: Math.round(totalHeight)
                                });
                            }
                        } catch (e) {
                            // å›é€€åˆ°é€šè¿‡çˆ¶çª—å£æ¶ˆæ¯
                            sendToParent({
                                type: 'resizeWindow',
                                height: Math.round(totalHeight)
                            });
                        }
                    }
                } catch (e) {
                    console.warn('[å°çª—ç¿»è¯‘] è°ƒæ•´çª—å£é«˜åº¦å¤±è´¥:', e);
                }
            }

            // Expose for external use
            window.adjustWindowHeight = adjustWindowHeight;

            window.miniTranslate = {
                setSourceText,
                setDetectedLanguage,
                setModels,
                updateResult,
                handleTranslationComplete,
                performTranslation
            };

            // ä» utools.dbStorage è¯»å–æœ€æ–°çš„å°çª—ç¿»è¯‘é…ç½®
            function refreshMiniTranslateConfig() {
                try {
                    if (typeof utools !== 'undefined' && utools.dbStorage) {
                        // è¯»å– uiConfig
                        const uiConfig = utools.dbStorage.getItem('uiConfig') || {};
                        miniTranslateConfig.instantAutoTranslate = uiConfig.miniTranslateInstantAutoTranslate !== false;
                        miniTranslateConfig.instantAutoTranslateDelay = uiConfig.miniTranslateInstantAutoTranslateDelay ?? 0.5;
                        miniTranslateConfig.autoTranslateOnBlur = uiConfig.miniTranslateAutoTranslateOnBlur === true;
                        miniTranslateConfig.autoCloseOnCopy = uiConfig.miniTranslateAutoCloseOnCopy !== false;
                        miniTranslateConfig.copyFirstModel = uiConfig.miniTranslateCopyFirstModel !== false;
                    }
                } catch (e) {
                    console.warn('[å°çª—ç¿»è¯‘] åˆ·æ–°é…ç½®å¤±è´¥:', e);
                }
            }

            // æš´éœ² handleInitialData åˆ°å…¨å±€ä½œç”¨åŸŸï¼Œä»¥ä¾¿çˆ¶çª—å£å¯é è°ƒç”¨
            window.handleInitialData = handleInitialData;
            window.refreshMiniTranslateConfig = refreshMiniTranslateConfig;

            // Initialize
            init();

            // åˆå§‹åŒ–åä¸»åŠ¨åˆ·æ–°é…ç½®ï¼ˆç¡®ä¿å³ä½¿æ³¨å…¥å¤±è´¥ä¹Ÿèƒ½è¯»å–åˆ°æœ€æ–°é…ç½®ï¼‰
            setTimeout(() => {
                refreshMiniTranslateConfig();
            }, 100);
        })();
    </script>
</body>

</html>