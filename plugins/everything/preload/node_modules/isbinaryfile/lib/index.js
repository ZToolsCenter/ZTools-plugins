"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.isBinaryFileSync=exports.isBinaryFile=void 0;const fs=require("fs"),util_1=require("util"),statAsync=(0,util_1.promisify)(fs.stat),openAsync=(0,util_1.promisify)(fs.open),closeAsync=(0,util_1.promisify)(fs.close),MAX_BYTES=512;class Reader{fileBuffer;size;offset;error;constructor(r,e){this.fileBuffer=r,this.size=e,this.offset=0,this.error=!1}hasError(){return this.error}nextByte(){return this.offset===this.size||this.hasError()?(this.error=!0,255):this.fileBuffer[this.offset++]}next(r){const e=new Array;for(let t=0;t<r;t++)e[t]=this.nextByte();return e}}function readProtoVarInt(r){let e=0,t=0;for(;!r.hasError();){const i=r.nextByte();if(t|=(127&i)<<7*e,!(128&i))break;e++}return t}function readProtoMessage(r){switch(7&readProtoVarInt(r)){case 0:return readProtoVarInt(r),!0;case 1:return r.next(8),!0;case 2:const e=readProtoVarInt(r);return r.next(e),!0;case 5:return r.next(4),!0}return!1}function isBinaryProto(r,e){const t=new Reader(r,e);let i=0;for(;;){if(!readProtoMessage(t)&&!t.hasError())return!1;if(t.hasError())break;i++}return i>0}async function isBinaryFile(r,e){if(isString(r)){isStatFile(await statAsync(r));const e=await openAsync(r,"r"),t=Buffer.alloc(512);return new Promise(((r,i)=>{fs.read(e,t,0,512,0,((n,s,o)=>{closeAsync(e),n?i(n):r(isBinaryCheck(t,s))}))}))}return void 0===e&&(e=r.length),isBinaryCheck(r,e)}function isBinaryFileSync(r,e){if(isString(r)){isStatFile(fs.statSync(r));const e=fs.openSync(r,"r"),t=Buffer.alloc(512),i=fs.readSync(e,t,0,512,0);return fs.closeSync(e),isBinaryCheck(t,i)}return void 0===e&&(e=r.length),isBinaryCheck(r,e)}function isBinaryCheck(r,e){if(0===e)return!1;let t=0;const i=Math.min(e,512);if(e>=3&&239===r[0]&&187===r[1]&&191===r[2])return!1;if(e>=4&&0===r[0]&&0===r[1]&&254===r[2]&&255===r[3])return!1;if(e>=4&&255===r[0]&&254===r[1]&&0===r[2]&&0===r[3])return!1;if(e>=4&&132===r[0]&&49===r[1]&&149===r[2]&&51===r[3])return!1;if(i>=5&&"%PDF-"===r.slice(0,5).toString())return!0;if(e>=2&&254===r[0]&&255===r[1])return!1;if(e>=2&&255===r[0]&&254===r[1])return!1;for(let e=0;e<i;e++){if(0===r[e])return!0;if((r[e]<7||r[e]>14)&&(r[e]<32||r[e]>127)){if(r[e]>=192&&r[e]<=223&&e+1<i){if(e++,r[e]>=128&&r[e]<=191)continue}else if(r[e]>=224&&r[e]<=239&&e+2<i){if(e++,r[e]>=128&&r[e]<=191&&r[e+1]>=128&&r[e+1]<=191){e++;continue}}else if(r[e]>=240&&r[e]<=247&&e+3<i&&(e++,r[e]>=128&&r[e]<=191&&r[e+1]>=128&&r[e+1]<=191&&r[e+2]>=128&&r[e+2]<=191)){e+=2;continue}if(t++,e>=32&&100*t/i>10)return!0}}return 100*t/i>10||!!(t>1&&isBinaryProto(r,i))}function isString(r){return"string"==typeof r}function isStatFile(r){if(!r.isFile())throw new Error("Path provided was not a file!")}exports.isBinaryFile=isBinaryFile,exports.isBinaryFileSync=isBinaryFileSync;